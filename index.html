<html>
<head>
        <meta charset="utf-8" />
		
		
        <title>CATNAT</title>
		 
		  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
		  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
		  

		  <!-- CSS  -->
		  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		  <link href="materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
		  <link href="nouislider.css" type="text/css" rel="stylesheet" media="screen,projection"/>
		  
		  <script src="https://d3js.org/d3.v4.min.js"></script>
		  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
	</head>
<body>
<div>
<div class="navbar-fixed">
<nav class="orange" role="navigation">
	<a href="#" class="brand-logo">CATNAT -Find more about natural disasters</a>
    
  </nav>	  
  </div>
   <div class="row" style="margin-bottom:0;">
   			
   			<div class="col s10 main" >
   				<div id="svgcontainer"></div>
   				
   			</div>
   			
   			<div class="col s10 row" id="selectpanel" >
   			<div id="onoff" onclick="displayhide()">
   				<i class="small material-icons" id="moreless">expand_more</i>
   				</div>
   			<div class="col s4 content" style="margin-top:-28px">   				
   				<div class="row">
   					<div class="col s6">
   						<p>
						      <label>
						        <input type="checkbox" class="filled-in zonegeo" name="North America" onclick="filterpoints()"/>
						        <span class="black-text" >North America</span>
						      </label>
						    </p>
						    <p>
						      <label>
						        <input type="checkbox" class="filled-in zonegeo" name="South America" onclick="filterpoints()"/>
						        <span class="black-text" >South America</span>
						      </label>
						    </p>
						    <p>
						      <label>
						        <input type="checkbox" class="filled-in zonegeo" name="Europe" onclick="filterpoints()" />
						        <span class="black-text"  >Europe</span>
						      </label>
					      </p>
   					</div>
   					<div class="col s6">
   						<p>
					      <label>
					        <input type="checkbox" class="filled-in zonegeo" name="Africa" onclick="filterpoints()" />
					        <span class="black-text" >Africa</span>
					      </label>
					    </p>
					    <p>
					      <label>
					        <input type="checkbox" class="filled-in zonegeo" name="Asia" onclick="filterpoints()" />
					        <span class="black-text"  >Asia</span>
					      </label>
					    </p>
					    <p>
					      <label>
					        <input type="checkbox" class="filled-in zonegeo" name="Oceania" onclick="filterpoints()" />
					        <span class="black-text"  >Oceania</span>
					      </label>
					    </p>
   					</div>
   				
   				</div>
   			</div>
   			<div class="col s8 content" style="margin-top:-28px">
   				<div class="row">
   					<div class="col s1 offset-s2"> <a class="tooltipped" data-position="bottom" data-tooltip="Drought"><img class="typecat" name="Drought" src="drought.png"  onclick="change(event,'Drought')" width="100%"/></a></div>
   					<div class="col s1"> <a class="tooltipped" data-position="bottom" data-tooltip="Earthquake"><img class="typecat" name="Earthquake" src="earthquake.png" onclick="change(event,'Earthquake')" width="100%"/></a></div>
   					<div class="col s1"> <a class="tooltipped" data-position="bottom" data-tooltip="Extreme Temperature (dry)"><img class="typecat" name="Extreme Temperature (dry)" src="extremetemperature.png" onclick="change(event,'Extreme Temperature (dry)')" width="100%" /></a></div>
   					<div class="col s1"> <a class="tooltipped" data-position="bottom" data-tooltip="Fog"><img class="typecat" name="Fog" src="fog.png" width="100%" onclick="change(event,'Fog')" /></a></div>
   					<div class="col s1"> <a class="tooltipped" data-position="bottom" data-tooltip="Impact"><img class="typecat" name="Impact" src="impact.png" onclick="change(event,'Impact')" width="100%"/></a></div>
   					<div class="col s1"> <a class="tooltipped" data-position="bottom" data-tooltip="Storm"><img class="typecat" name="Storm" src="storm.png" onclick="change(event,'Storm')" width="100%"/></a></div>
   					<div class="col s1"> <a class="tooltipped" data-position="bottom" data-tooltip="Wildfire"><img class="typecat" name="Wildfire" src="wildfire.png" onclick="change(event,'Wildfire')" width="100%"/></a></div>
   					<div class="col s1"> <a class="tooltipped" data-position="bottom" data-tooltip="Volcanic activity"><img class="typecat" name="Volcanic activity" src="volcano.png" onclick="change(event,'Volcanic activity')" width="100%"/></a></div>
   				</div>
   				<div id="test-slider" style="color:white;"></div>
   				<div id="svgcontainerbottom" style="margin-bottom:20px"></div>
   				</div>
   				</div>
   			<div class="col s2 main" >
   				<div id="pres">
						<p>On this map, you can see natural disasters according to their type, their place and the year they happened</p>
						<p>Some natural disasters are linked to others (for instance : earthquakes and storms). You can have a look at those links one the figure just behind.</p>
					</div>
					<div id="details">
					</div>
   				<div id="svgcontainer3"></div>
   			</div>
   		
   </div>

  





</div>



 <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="materialize.js"></script>
  <script src="nouislider.js"></script>
  <script src="init.js"></script>
  <script src="wNumb.js"></script>
<script>

document.addEventListener('DOMContentLoaded', function() {
    var elems = document.querySelectorAll('.tooltipped');
    var instances = M.Tooltip.init(elems);
  });
  
var debut=1900
var fin=2020

function filterPips(value, type) {
    return value % 10==0 ? 2 : 0;
}


var slider = document.getElementById('test-slider');
noUiSlider.create(slider, {
 start: [1900, 2019],
 
 connect: true,
 step: 1,
 orientation: 'horizontal', // 'horizontal' or 'vertical'
 
 range: {
   'min': debut,
   'max': fin
 },
   format: wNumb({
     decimals: 0
   }),
   pips: {
       mode: 'steps',
       density: 3,
       filter: filterPips,
       format: wNumb({
           decimals: 0
       })
   }
   
});
var buttons =document.getElementsByClassName('noUi-touch-area')
slider.noUiSlider.on('update', function (values, handle, unencoded, tap, positions) {
   
    buttons[0].innerHTML='<p style="padding:0;margin:0;margin-top:8px;margin-left:4px;">'+values[0]+'</p>'
    buttons[1].innerHTML='<p style="padding:0;margin:0;margin-top:8px;margin-left:4px;">'+values[1]+'</p>'
});

slider.noUiSlider.on('end', function(values,handle,unencoded){
	debut=unencoded[0]
	fin=unencoded[1]
	filterpoints()
	filterlinegraph()
	
});
</script>
<script>
		var height = window.innerHeight -64;
		var mains=document.getElementsByClassName("main")
		for (var i = 0; i < mains.length; i++) {
			mains[i].style.height=height;
		
		}
		var hide=0;
		//function to hide or display the menu tool bar
		function displayhide(){
			if(hide==1)
				{
				var mains=document.getElementsByClassName("content")
				for (var i = 0; i < mains.length; i++) {
					mains[i].style.display='block';
				
					}
				document.getElementById('selectpanel').style.height='auto';
				document.getElementById('moreless').innerHTML='expand_more';
				hide=0
				}
			else{
				var mains=document.getElementsByClassName("content")
				for (var i = 0; i < mains.length; i++) {
					mains[i].style.display='none';
				
				}
				document.getElementById('selectpanel').style.height='0px';
				document.getElementById('moreless').innerHTML='expand_less';
				hide=1
			}
		}
  		
		//definition of all the svg containers
		var svg = d3.select( "#svgcontainer" )
  		.append( "svg" )
		  .attr( "height", height );
		
		var margin = {top:0, right:0, bottom:0, left:0};
	    var width = document.getElementById('svgcontainerbottom').offsetWidth-margin.right-margin.left,
	        height2 = 50-margin.top-margin.bottom;
		var svg2 = d3.select( "#svgcontainerbottom" )
  		.append( "svg" )
		  .attr( "height", height2 )
		.append("g")
	  	.attr("transform", "translate("+margin.left+","+margin.top+")")
	  	
	  	var svg3 = d3.select( "#svgcontainer3" )
  		.append( "svg" )
		  .attr( "height", 200 );
	  	
	  	
    var projection = d3.geoNaturalEarth1();
    projection.center([60.454071, -13]).scale(140)

    var path = d3.geoPath() // d3.geo.path avec d3 version 3
                 .projection(projection);
    
    var link = svg3.selectAll(".link"),
    node = svg3.selectAll(".node");

	var simulation;
	  
	// Init graph data structure
	var graph = {nodes:[], links:[]};
	
	//definition gradient couleur for line chart bottom date
	var datagradient=[                             
        {offset: "0%", color: "red"}, 
        {offset: "100%", color: "red"}    
    ]
	var gradient= svg2.append("linearGradient")                
    .attr("id", "line-gradient")            
    .attr("gradientUnits", "userSpaceOnUse")    
    .attr("x1", "0%").attr("y1", 0)         
    .attr("x2", "100%").attr("y2", 0)
    gradient.selectAll("stop")                      
    .data(datagradient)
    .enter().append("stop")         
    .attr("offset", function(d) { return d.offset; })   
    .attr("stop-color", function(d) { return d.color; });
	
	
	var keys2=[]
	var nodes=[]
		// Load external data and boot
		
d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson", function(data){

  
  
    // Draw the map
    svg.append("g")
        .selectAll("path")
        .data(data.features)
        .enter().append("path")
            .attr("fill", "#69b3a2")
            .attr("d", path)
            .style("stroke", "#fff")
            .style("opacity", 0.6)
})
var couleurlist
    d3.csv("https://raw.githubusercontent.com/glegall7/datavizCATNAT/master/test6.csv", function(data){
      //console.log(data)
      d3.csv("https://raw.githubusercontent.com/glegall7/datavizCATNAT/master/couleur.csv", function(couleur){
      //console.log(couleur)
      d3.csv("https://raw.githubusercontent.com/glegall7/datavizCATNAT/master/liencatnat2.csv", function(error, datagraph) {
      
    	  couleurlist=couleur
   		//tracé graphique nb catastrophe par année
      var catbyyear = d3.nest()
		.key(function(d) { return d.year; })
		.rollup(function(leaves) { return leaves.length; })
		.entries(data);
      
      
      
      var x = d3.scaleTime()
        .domain(d3.extent(catbyyear,function(d){return d.key}))
        .range([0, width])

      var y = d3.scaleLinear()
        .domain([d3.min(catbyyear, function(d){return d.value}),
                 d3.max(catbyyear, function(d){return d.value})])
        .range([0,height2]);




        var line2 = d3.line()
        .curve(d3.curveMonotoneX)
        .x(function(d,i){return x(d.key)})
        .y(function(d,i){return 50-y(d.value);})

        
        var lines = svg2.append("g").selectAll("path").data([catbyyear]).enter()
        .append("path")
        .attr("d", line2)
        .attr("id", "line")
        .attr("fill", "none")
        .attr("stroke", "red")
        
        
      //fin tracé graphique cat/année
      
    	//graph liencatnat
    	var symbol_unique= d3.map(datagraph, function(d){return d.Disaster;}).keys()
		  
		  var symbol_unique2=d3.map(datagraph, function(d){return d.Subdisaster;}).keys()
		  
		  symbol_unique =symbol_unique.concat(symbol_unique2)
		  keys2=d3.map(symbol_unique, function(d){return d;}).keys()
		  
		  var nb_nodes = keys2.length;

			graph.nodes = d3.range(nb_nodes).map(function() {  
			  return {}; 
			})
			console.log(graph)
			links=[]
			datagraph.forEach(function(d,i){
			  var source=keys2.indexOf(d.Disaster)
			  var target=keys2.indexOf(d.Subdisaster)
			  graph.links.push({"source": source, "target": target,"size":parseInt(d.number)})
			})
			
			console.log(graph)
			
			
			function force_layout() {
			
			  // TODO: use different parame
			  
			 simulation = d3.forceSimulation(graph.nodes)
			      .force("link", d3.forceLink(graph.links).id(d => d.index))
			      .force("charge", d3.forceManyBody())
			      .force("center", d3.forceCenter(150, 400 / 2));
			
			  simulation.on("tick", function() {
					graph_update(0)
			  });

			}
			
			function graph_update(delay) {

				 link.transition().duration(delay)
				    .attr("x1", function(d) { return 2*d.target.x/3; })
				    .attr("y1", function(d) { return 2*d.target.y/3; })
				    .attr("x2", function(d) { return 2*d.source.x/3; })
				    .attr("y2", function(d) { return 2*d.source.y/3; })
				  	

				  node.transition().duration(delay)
				    .attr("transform", function(d) { 
				      return "translate("+2*d.x/3+","+2*d.y/3+")"; 
				  });

				}
			
			force_layout();
			  graph.nodes.forEach(function(d,i){
			    d.name=keys2[i]
			  })
			  
			  link = link.data(graph.links)
			  .enter().append("line")
			    .attr("class", "link")
					.style("stroke-width", function(d){return Math.min(d.size/6,3)})
			.attr("stroke","black")
			.attr("opacity", 0.6)
			
			node = node.data(graph.nodes)
			  .enter().append("g").attr("class", "node");
			
			node.append("circle")
			  .attr("r", 3)
			  .attr("fill","white")
			  .attr("stroke","black")
				.on("mouseover",function(d){
				d3.selectAll("line").filter(function(e){return (e.source.index==d.index)||(e.target.index==d.index)})
			  .attr("stroke","red")
			})
			.on("mouseout",function(d){
				d3.selectAll("line").filter(function(e){return (e.source.index==d.index)||(e.target.index==d.index)})
			  .attr("stroke","black")
			})
			force_layout();
			  graph.nodes.forEach(function(d,i){
			    d.name=keys2[i]
			    couleur.forEach(function(e,j){
			    	if(couleur[j].Cat==keys2[i]){
			    		svg3.selectAll("circle").filter(function(d){return d.name==keys2[i]})
			    		.attr("fill",couleur[j].Color)
			    		.attr("r",4)
			    	}
			    })
			  })
			force_layout();
			force_layout();
			force_layout();
			force_layout();
			  force_layout();
			  force_layout();
			  force_layout();
			 force_layout();
		  
		  //fin liencatant
        
      svg.append("g").selectAll("circle")
		.data(data).enter()
		.append("circle")
		.attr("cx", function (d) {return projection([d.newlongitude,d.newlatitude])[0]; })
		.attr("cy", function (d) { return projection([d.newlongitude,d.newlatitude])[1]; })
		.attr("r", 2)
		.attr("fill", function (d) {
			var color=''
			for (var item in couleur) {
				if(couleur[item]['Cat']==d.Disaster_type){
				color=couleur[item]['Color']
					}
				}
			
			return color})
		.style("opacity", 0.8)
		.on("mouseover", function(d,i){ 
			if(d3.select(this).style("opacity")>=0.8){
				document.getElementById("pres").style.display="none"
          d3.select(this).style("opacity",1)
          .attr("r", 4)
          elm=document.getElementById("details")
          elm.innerHTML="<p>Details:</p> <p>You will find below the disaster informations: <ul> <li>Country : "+d.Country+'</li>' + '<li>Disaster Type : '+d.Disaster_type+'</li>' + '<li>Year: '+ d.year+'</li>' + '<li>Total deaths : '+ d.Total_deaths+'</li>'+ '<li>Longitude: '+ d.Longitude+'</li>'+ '<li>Latitude: '+ d.Latitude+'</li></ul></p>'
			}
    })
    .on("mouseout", function(d) {
    	if(d3.select(this).style("opacity")>=0.8){
    		document.getElementById("pres").style.display="block"
    		d3.select(this).style("opacity",0.8)
          .attr("r", 2)
          elm=document.getElementById("details")
          elm.innerHTML=''   ;  
    		filterpoints()
    	}
    })
      })
      })
    })

    function change(event,elm){
			if(event.target.style.border!=''){
			event.target.style.border="";
			event.target.style.borderRadius="0";
			}
			else{
				event.target.style.border="3px solid #8bc34a";
				event.target.style.borderRadius="50%";
			}
			filterpoints()
			
			
		}
	
	//function to select points base on user choice (region, period of time and type of catnat)
	function filterpoints(){
		//coordonnes continent
		coord=[[-80,35,350,'North America'],[25,48,670,'Europe'],[20,-5,300,'Africa'],
			[-60,-30,320,'South America'],[80,20,320,'Asia'],[140,-30,300,'Oceania']]
		//récupération des options de filtrage active
		optionstype=document.getElementsByClassName('typecat')
		optiontypeactive=[]
		for (var i = 0; i < optionstype.length; i++) {
			    
			    if(optionstype[i].style.border!=''){
			    	optiontypeactive.push(optionstype[i].name)
			    }
			}
		zonegeo=document.getElementsByClassName('zonegeo')
		zonegeoactive=[]
		coordactive=[]
		for (var i = 0; i < zonegeo.length; i++) {
			    
			    if(zonegeo[i].checked==true){
			    	zonegeoactive.push(zonegeo[i].name)
			    	for (var j = 0; j < coord.length; j++) {
			    		if(zonegeo[i].name==coord[j][3]){
			    			coordactive.push(coord[j])
			    		}
			    	}
			    }
			}
		
		//debut du filtrage
		//on met tous les ercles en petits et presque transparent
		svg.selectAll("circle")
				.style("opacity", 0.3)
				.attr("r", 2)
		if(zonegeoactive.length==0 && optiontypeactive.length>0){
			//centrage carte monde
			path = path.projection(projection.center([0,0]).scale(180));
					svg.selectAll("path")
						.transition()
				      	.duration(0)
				      	.attr("d", path);
					svg3.selectAll("line")
					.attr("stroke","black")
			for (var i = 0; i < optiontypeactive.length; i++) {
				
				svg.selectAll("circle")
				.filter(function(d) { return d.Disaster_type == optiontypeactive[i] })
				.style("opacity", 0.8)
				.attr("r", 3)
				
				svg3.selectAll("line")
				.filter(function(e){return (e.source.name==optiontypeactive[i])||(e.target.name==optiontypeactive[i])})
			  .attr("stroke", function (d) {
				var color=''
				couleurlist.forEach (function(d){
					if(d.Cat==optiontypeactive[i]){
					color=d.Color
						}
					})
				return color})
				
			}
		}
		if(optiontypeactive.length==0 && zonegeoactive.length>0){
			coord=barycentre(coordactive)
			path = path.projection(projection.center([coord[0], coord[1]]).scale(coord[2]));
					svg.selectAll("path")
						.transition()
				      	.duration(0)
				      	.attr("d", path);
			for (var i = 0; i < zonegeoactive.length; i++) {
				svg.selectAll("circle")
				.filter(function(d) { return (d.continent == zonegeoactive[i])})
				.style("opacity", 0.8)
				.attr("r", 3)
			}
		}
		if(optiontypeactive.length>0 && zonegeoactive.length>0){
			coord=barycentre(coordactive)
			path = path.projection(projection.center([coord[0], coord[1]]).scale(coord[2]));
					svg.selectAll("path")
						.transition()
				      	.duration(0)
				      	.attr("d", path);
					console.log(optiontypeactive);
			for (var i = 0; i < zonegeoactive.length; i++) {
				for (var j = 0; j < optiontypeactive.length; j++) {
					
					svg.selectAll("circle")
					.filter(function(d) { return (d.Disaster_type == optiontypeactive[j] && d.continent == zonegeoactive[i])})
					.style("opacity", 0.8)
					.attr("r", 4)
				}
			}
		}
		if(zonegeoactive.length==0 && optiontypeactive.length==0){
			//centrage carte monde
			path = path.projection(projection.center([0, 0]).scale(180));
					svg.selectAll("path")
						.transition()
				      	.duration(0)
				      	.attr("d", path);
				console.log(optiontypeactive[i]);
				svg.selectAll("circle")
				.style("opacity", 0.8)
				.attr("r", 2)
			
		}
		svg.selectAll("circle")
		.filter(function(d) { return (d.year < debut || d.year > fin)})
		.style("opacity", 0)
		.attr("r", 2)

		svg.selectAll("circle")
		.attr("cx", function (d) {return projection([d.newlongitude,d.newlatitude])[0]; })
		.attr("cy", function (d) { return projection([d.newlongitude,d.newlatitude])[1]; })
	}
	
	
	function filterlinegraph(){
		var interval=2020-1900
		var debutpourc=String((debut-1900)/interval*100)+'%'
		var debutpourc2=String((debut-1900)/interval*100+1)+'%'
		var finpourc2=String(100-(2020-fin)/interval*100-1)+'%'
		var finpourc=String(100-(2020-fin)/interval*100)+'%'
		gradient.selectAll("stop").remove()
		datagradient=[                             
	        {offset: "0%", color: "grey"}, 
	        {offset: debutpourc, color: "grey"}, 
	        {offset: debutpourc2, color: "red"},
	        {offset: finpourc2, color: "red"},
	        {offset: finpourc, color: "grey"}, 
	        {offset: "100%", color: "grey"}
	    ]
		gradient.selectAll("stop")                      
	    .data(datagradient)                  
		.enter().append("stop")         
	    .attr("offset", function(d) { return d.offset; })   
	    .attr("stop-color", function(d) { return d.color; });
	}
	
	function barycentre(listecoord){
		lat=0
		longi=0
		scale=1000
		if(listecoord.length>2){
			return [0,0,180]
		}
		for (var i = 0; i < listecoord.length; i++) {
			lat=lat+listecoord[i][0]
			longi=longi+listecoord[i][1]
			scale=Math.min(scale,listecoord[i][2])
		}
		return [lat/listecoord.length, longi/listecoord.length, scale/Math.sqrt(listecoord.length)]
	}
	function zoom(a,b,c,continent){
				
		filterpoints()
	}
	filterpoints()
  </script>
  <style>
  	svg { display: block;
  	width:100%}
  	g { 
  	width:100%}
  	.main{height:800px}
  	
  	#selectpanel{
  	background-color:rgba(240,240,240,0.7);
  	padding-top:10px;
  	padding-left:20px;
  	position:absolute;
  	bottom:0;
  	margin-bottom:0;
  	}
  	
  	#onoff{
  		position:relative;
  		background-color:rgba(240,240,240,0.7);
  		top:-38px;
  		width:28px;
  		height:28px;
  		left:50%
  	}
  	
  	#line {                         
    fill: none;                 
    stroke: url(#line-gradient);    
    stroke-width: 2px;          
}
  </style>


    
</body>

</html>
