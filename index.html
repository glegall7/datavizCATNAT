<html>
<head>
        <meta charset="utf-8" />
		
		
        <title>CATNAT</title>
		 
		  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
		  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
		  

		  <!-- CSS  -->
		  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		  <link href="materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
		  <link href="nouislider.css" type="text/css" rel="stylesheet" media="screen,projection"/>
		  
		  <script src="https://d3js.org/d3.v4.min.js"></script>
		  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
	</head>
<body>
<div>
<div class="navbar-fixed">
<nav class="orange" role="navigation">
	<a href="#" class="brand-logo">CATNAT -Find more about natural disasters</a>
    
  </nav>	  
  </div>
   <div class="row">
   			<div class="col s2 main orange lighten-2">
   				<form action="#">
   				<p>
				      <label>
				        <input class="with-gap" name="group1" type="radio" checked />
				        <span class="white-text">World Map</span>
				      </label>
				    </p>
				    <p>
				      <label>
				        <input class="with-gap" name="group1" type="radio" />
				        <span class="white-text">Tree Map</span>
				      </label>
				    </p>
				    <p>
				      <label>
				        <input class="with-gap " name="group1" type="radio"  />
				        <span class="white-text">Link Graph</span>
				      </label>
				    </p>
			    <p>
			      <label>
			        <input type="checkbox" class="filled-in zonegeo" name="North America" onclick="zoom(-60,30,350,'North America')"/>
			        <span class="white-text" >North America</span>
			      </label>
			    </p>
			    <p>
			      <label>
			        <input type="checkbox" class="filled-in zonegeo" name="Europe" onclick="zoom(30,48,670, 'Europe')" />
			        <span class="white-text"  >Europe</span>
			      </label>
			    </p>
			    <p>
			      <label>
			        <input type="checkbox" class="filled-in zonegeo" name="Africa" onclick="zoom(30,-9,300,'Africa')" />
			        <span class="white-text" >Africa</span>
			      </label>
			    </p>
			    
			  </form>
   			</div>
   			<div class="col s8 main" >
   				<div id="svgcontainer"></div>
   				<div class="row">
   					<div class="col s1 offset-s2"> <img class="typecat" name="Drought" src="drought.png"  onclick="change(event,'Drought')" width="100%"/></div>
   					<div class="col s1"> <img class="typecat" name="Earthquake" src="earthquake.png" onclick="change(event,'Earthquake')" width="100%"/></div>
   					<div class="col s1"> <img class="typecat" name="Extreme Temperature (dry)" src="extremetemperature.png" onclick="change(event,'Extreme Temperature (dry)')" width="100%" /></div>
   					<div class="col s1"> <img class="typecat" name="Fog" src="fog.png" width="100%" onclick="change(event,'Fog')" /></div>
   					<div class="col s1"> <img class="typecat" name="Impact" src="impact.png" onclick="change(event,'Impact')" width="100%"/></div>
   					<div class="col s1"> <img class="typecat" name="Storm" src="storm.png" onclick="change(event,'Storm')" width="100%"/></div>
   					<div class="col s1"> <img class="typecat" name="Wildfire" src="wildfire.png" onclick="change(event,'Wildfire')" width="100%"/></div>
   					<div class="col s1"> <img class="typecat" name="Volcanic activity" src="volcano.png" onclick="change(event,'Volcanic activity')" width="100%"/></div>
   				</div>
   				<div id="test-slider"></div>
   				<div id="valuesholder"></div>
   			</div>
   			<div class="col s2 main" id="details">
   				
   			</div>
   		
   </div>

  





</div>



<footer class="page-footer orange" >
    
    <div class="footer-copyright">
      <div class="container">
      Créé par Guillaume Le Gall, Jean-Thomas Beaudoin et Donatien Vaast
      </div>
    </div>
  </footer>
 <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="materialize.js"></script>
  <script src="nouislider.js"></script>
  <script src="init.js"></script>
  <script src="wNumb.js"></script>
<script>
var debut=1900
var fin=2020
function doSomething(values, handle, unencoded, tap, positions) {
    // values: Current slider values (array);
    // handle: Handle that caused the event (number);
    // unencoded: Slider values without formatting (array);
    // tap: Event was caused by the user tapping the slider (boolean);
    // positions: Left offset of the handles (array);
}

function filterPips(value, type) {
   	console.log(value%10==0);
    return value % 10==0 ? 2 : 0;
}

var valuesholder = document.getElementById('valuesholder');

var slider = document.getElementById('test-slider');
noUiSlider.create(slider, {
 start: [1900, 2019],
 
 connect: true,
 step: 1,
 orientation: 'horizontal', // 'horizontal' or 'vertical'
 
 range: {
   'min': debut,
   'max': fin
 },
   format: wNumb({
     decimals: 0
   }),
   pips: {
       mode: 'steps',
       density: 3,
       filter: filterPips,
       format: wNumb({
           decimals: 0
       })
   }
});
slider.noUiSlider.on('update', function (values) {
    valuesholder.innerHTML = values.join(' : ');
});

slider.noUiSlider.on('end', function(values,handle,unencoded){
	console.log(unencoded)
	debut=unencoded[0]
	fin=unencoded[1]
	filterpoints()
	
});
</script>
<script>
		
  		var height = 400;
		var svg = d3.select( "#svgcontainer" )
  		.append( "svg" )
		  .attr( "height", height );

    var projection = d3.geoNaturalEarth1();
    projection.center([60.454071, -13]).scale(140)

    var path = d3.geoPath() // d3.geo.path avec d3 version 3
                 .projection(projection);
    

		// Load external data and boot
		
d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson", function(data){

  
  
    // Draw the map
    svg.append("g")
        .selectAll("path")
        .data(data.features)
        .enter().append("path")
            .attr("fill", "#69b3a2")
            .attr("d", path)
            .style("stroke", "#fff")
            .style("opacity", 0.6)
})
    d3.csv("https://raw.githubusercontent.com/glegall7/datavizCATNAT/master/test6.csv", function(data){
      //console.log(data)
      d3.csv("https://raw.githubusercontent.com/glegall7/datavizCATNAT/master/couleur.csv", function(couleur){
      //console.log(couleur)
      
      svg.append("g").selectAll("circle")
		.data(data).enter()
		.append("circle")
		.attr("cx", function (d) {return projection([d.newlongitude,d.newlatitude])[0]; })
		.attr("cy", function (d) { return projection([d.newlongitude,d.newlatitude])[1]; })
		.attr("r", "1px")
		.attr("fill", function (d) {
			var color=''
			for (var item in couleur) {
				if(couleur[item]['Cat']==d.Disaster_type){
				color=couleur[item]['Color']
					}
				}
			
			return color})
		.style("opacity", 1)
		.on("mouseover", function(d,i){ 
    			d3.selectAll("circle")
          .style("opacity", .3)
          d3.select(this).style("opacity",1)
          elm=document.getElementById("details")
          elm.innerHTML='<li>'+d.Country+'</li>'
    })
    .on("mouseout", function(d) {filterpoints()
          elm=document.getElementById("details")
          elm.innerHTML=''   ;   
    })
    
      })
    })

    function change(event,elm){
			if(event.target.style.border!=''){
			event.target.style.border="";
			event.target.style.borderRadius="0";
			}
			else{
				event.target.style.border="3px solid #8bc34a";
				event.target.style.borderRadius="50%";
			}
			filterpoints()
			
			
		}
	function filterpoints(){
		//coordonnes continent
		coord=[[-60,30,350,'North America'],[30,48,670,'Europe'],[30,-9,300,'Africa']]
		//récupération des options de filtrage active
		optionstype=document.getElementsByClassName('typecat')
		optiontypeactive=[]
		for (var i = 0; i < optionstype.length; i++) {
			    
			    if(optionstype[i].style.border!=''){
			    	optiontypeactive.push(optionstype[i].name)
			    }
			}
		zonegeo=document.getElementsByClassName('zonegeo')
		zonegeoactive=[]
		coordactive=[]
		for (var i = 0; i < zonegeo.length; i++) {
			    
			    if(zonegeo[i].checked==true){
			    	zonegeoactive.push(zonegeo[i].name)
			    	for (var j = 0; j < coord.length; j++) {
			    		if(zonegeo[i].name==coord[j][3]){
			    			coordactive.push(coord[j])
			    		}
			    	}
			    }
			}
		
		//debut du filtrage
		//on met tous les ercles en petits et presque transparent
		d3.selectAll("circle")
				.style("opacity", 0.3)
				.attr("r", 2)
		if(zonegeoactive.length==0 && optiontypeactive.length>0){
			//centrage carte monde
			path = path.projection(projection.center([60.454071, -13]).scale(140));
					d3.selectAll("path")
						.transition()
				      	.duration(0)
				      	.attr("d", path);
			for (var i = 0; i < optiontypeactive.length; i++) {
				
				d3.selectAll("circle")
				.filter(function(d) { return d.Disaster_type == optiontypeactive[i] })
				.style("opacity", 0.8)
				.attr("r", 3)
			}
		}
		if(optiontypeactive.length==0 && zonegeoactive.length>0){
			coord=barycentre(coordactive)
			path = path.projection(projection.center([coord[0], coord[1]]).scale(coord[2]));
					d3.selectAll("path")
						.transition()
				      	.duration(0)
				      	.attr("d", path);
			for (var i = 0; i < zonegeoactive.length; i++) {
				d3.selectAll("circle")
				.filter(function(d) { return (d.continent == zonegeoactive[i])})
				.style("opacity", 0.8)
				.attr("r", 3)
			}
		}
		if(optiontypeactive.length>0 && zonegeoactive.length>0){
			coord=barycentre(coordactive)
			path = path.projection(projection.center([coord[0], coord[1]]).scale(coord[2]));
					d3.selectAll("path")
						.transition()
				      	.duration(0)
				      	.attr("d", path);
					console.log(optiontypeactive);
			for (var i = 0; i < zonegeoactive.length; i++) {
				for (var j = 0; j < optiontypeactive.length; j++) {
					
					d3.selectAll("circle")
					.filter(function(d) { return (d.Disaster_type == optiontypeactive[j] && d.continent == zonegeoactive[i])})
					.style("opacity", 0.8)
					.attr("r", 4)
				}
			}
		}
		if(zonegeoactive.length==0 && optiontypeactive.length==0){
			//centrage carte monde
			path = path.projection(projection.center([60.454071, -13]).scale(140));
					d3.selectAll("path")
						.transition()
				      	.duration(0)
				      	.attr("d", path);
				console.log(optiontypeactive[i]);
				d3.selectAll("circle")
				.style("opacity", 0.8)
				.attr("r", 2)
			
		}
		svg.selectAll("circle")
		.attr("cx", function (d) {return projection([d.newlongitude,d.newlatitude])[0]; })
		.attr("cy", function (d) { return projection([d.newlongitude,d.newlatitude])[1]; })
	}
	
	function barycentre(listecoord){
		lat=0
		longi=0
		scale=1000
		for (var i = 0; i < listecoord.length; i++) {
			lat=lat+listecoord[i][0]
			longi=longi+listecoord[i][1]
			scale=Math.min(scale,listecoord[i][2])
		}
		return [lat/listecoord.length, longi/listecoord.length, scale/Math.sqrt(listecoord.length)]
	}
	function zoom(a,b,c,continent){
				
		filterpoints()
	}
  </script>
  <style>
  	svg { display: block;
  	width:100%}
  	g { 
  	width:100%}
  	.main{height:600px}
  	
  </style>


    
</body>

</html>
